<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alteration Work Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color-scheme: light; }
    * { box-sizing: border-box; }
    body { margin: 0; background: #f3f4fb; color: #111827; font-size: 15px; }
    .page { max-width: 1200px; margin: 0 auto; padding: 1.2rem 0.9rem 2.5rem; }
    header { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; }
    .brand-left { display: flex; align-items: center; }
    .brand-logo { height: 40px; max-width: 160px; object-fit: contain; display: block; }
    .brand-text { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-width: 0; }
    .brand-title { font-size: 1.15rem; font-weight: 600; color: #111827; line-height: 1.2; }
    .brand-subtitle { font-size: 0.78rem; color: #6b7280; line-height: 1.2; }
    .header-actions { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.45rem 1.1rem; border-radius: 999px; border: none;
      font-size: 0.9rem; cursor: pointer; white-space: nowrap; transition: box-shadow 0.15s, transform 0.05s, background 0.15s, color 0.15s; }
    .btn-primary { background: #2563eb; color: #ffffff; }
    .btn-primary:hover { box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35); transform: translateY(-1px); }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-sm { padding: 0.25rem 0.7rem; font-size: 0.8rem; }
    .btn-link { background: transparent; color: #2563eb; border: none; padding: 0; }
    .card { background: #ffffff; border-radius: 0.75rem; padding: 1.25rem 1.5rem; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06); margin-bottom: 1.1rem; }
    .card-title { font-size: 0.98rem; font-weight: 600; margin-bottom: 0.9rem; }
    label { font-size: 0.8rem; color: #4b5563; display: block; margin-bottom: 0.3rem; }
    input[type="text"], input[type="date"], input[type="time"], select {
      width: 100%; padding: 0.45rem 0.6rem; border-radius: 0.5rem; border: 1px solid #d1d5db; font-size: 0.85rem; background: #f9fafb; outline: none;
    }
    input:focus, select:focus { border-color: #2563eb; background: #ffffff; box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12); }
    input[type="file"] { font-size: 0.8rem; }
    textarea {
      width: 100%; min-height: 80px; resize: vertical; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.45rem 0.6rem; font-size: 0.85rem; background: #f9fafb; outline: none;
    }
    textarea:focus { border-color: #2563eb; background: #ffffff; box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12); }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); column-gap: 1.25rem; row-gap: 1.1rem; }
    .full-span { grid-column: 1 / -1; }
    .section-break { margin-top: 0.5rem; padding-top: 0.6rem; border-top: 1px dashed #e5e7eb; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead { background: #f9fafb; }
    th, td { padding: 0.55rem 0.6rem; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: middle; }
    th { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.03em; }
    tbody tr:hover { background: #f3f4ff; }
    .empty-row td { text-align: center; color: #9ca3af; padding: 1rem 0.5rem; font-size: 0.85rem; }
    .thumb-wrapper { width: 56px; height: 56px; border-radius: 0.6rem; background: #f3f4f6; border: 1px solid #e5e7eb; overflow: hidden;
      display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #9ca3af; }
    .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .badge { display: inline-block; padding: 0.12rem 0.55rem; border-radius: 999px; font-size: 0.72rem; background: #e5e7eb; color: #374151; margin-right: 0.4rem; }
    .status-select { font-size: .78rem; border-radius: 999px; padding: .28rem .55rem; border: 1px solid #e5e7eb; background: #fff; }
    .image-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; }
    .image-modal.visible { display: flex; }
    .image-modal-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.85); }
    .image-modal-inner { position: relative; max-width: 95vw; max-height: 90vh; z-index: 1; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5); border-radius: 0.75rem; overflow: hidden; background: #000; }
    .image-modal-inner img { display: block; max-width: 100%; max-height: 90vh; object-fit: contain; }
    .image-modal-close { position: absolute; top: 0.3rem; right: 0.8rem; color: #f9fafb; font-size: 1.6rem; cursor: pointer; z-index: 2; }
    @media (max-width: 640px) {
      body { font-size: 14px; }
      .page { padding: 1rem 0.7rem 2rem; }
      header { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .brand-logo { height: 32px; max-width: 140px; }
      .brand-title { font-size: 1rem; }
      .brand-text { width: 100%; align-items: center; text-align: center; }
      .header-actions { width: 100%; justify-content: flex-start; }
      .form-grid { grid-template-columns: 1fr; }
      th:nth-child(5), td:nth-child(5), th:nth-child(7), td:nth-child(7) { display: none; }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="brand-left">
      <img src="chitrali-logo.png" alt="Chitrali" class="brand-logo" />
    </div>
    <div class="brand-text">
      <div class="brand-title">Alteration Tracker</div>
      <div class="brand-subtitle">Chitrali Fashion</div>
    </div>
    <div class="header-actions">
      <span class="badge">Admin</span>
      <button class="btn btn-primary" id="addNewWorkBtn">Add New Work</button>
    </div>
  </header>

  <section class="card" id="formCard">
    <div class="card-title" id="formTitle">Add New Alteration Work</div>
    <form id="workForm">
      <input type="hidden" id="workId" />
      <div class="form-grid">
        <div><label for="billNumber">Bill Number *</label><input id="billNumber" required /></div>
        <div><label for="itemName">Item Name *</label><input id="itemName" required /></div>
        <div>
          <label for="tailorSelect">Tailor Name *</label>
          <select id="tailorSelect" required>
            <option value="">Select</option>
            <option value="Faisal">Faisal</option>
            <option value="SALMAN">SALMAN</option>
            <option value="Rahul">Rahul</option>
            <option value="Imran">Imran</option>
          </select>
        </div>
        <div>
          <label for="status">Work Status *</label>
          <select id="status" required class="status-select">
            <option value="PENDING">Pending</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="DONE">Done</option>
          </select>
        </div>

        <div><label for="dateAssigned">Date Assigned *</label><input type="date" id="dateAssigned" required /></div>
        <div><label for="dateDelivery">Date of Delivery *</label><input type="date" id="dateDelivery" required /></div>
        <div><label for="timeDelivery">Time of Delivery</label><input type="time" id="timeDelivery" /></div>
        <div>
          <label for="packedFlag">Packed</label>
          <div style="display:flex;align-items:center;gap:.4rem;margin-top:.3rem;">
            <input type="checkbox" id="packedFlag" />
            <span style="font-size:.8rem;color:#4b5563;">Mark as packed (auto sets status = Done)</span>
          </div>
        </div>

        <div class="full-span section-break">
          <label for="imageInput">Item Image (camera / gallery)</label>
          <input type="file" id="imageInput" accept="image/*" capture="environment" />
          <small style="display:block;margin-top:.25rem;color:#6b7280;">
            Images upload via <b>/upload</b> (multipart/form-data). Only the final HTTPS URL is saved.
          </small>
          <div style="margin-top:.4rem;">
            <div class="thumb-wrapper" id="imagePreview" title="Click to preview full screen"><span>Preview</span></div>
          </div>
          <small id="fileInfo" style="display:block;margin-top:.35rem;color:#6b7280;"></small>
        </div>

        <div class="full-span">
          <label for="notes">Notes / Measurements</label>
          <textarea id="notes" placeholder="Shorten length, adjust waist, etc."></textarea>
        </div>
      </div>

      <div style="margin-top:1.1rem;display:flex;gap:.6rem;flex-wrap:wrap;">
        <button class="btn btn-primary" type="submit" id="saveBtn">Add Work</button>
        <button class="btn btn-secondary" type="button" id="formCancelBtn">Clear</button>
      </div>

      <div id="saveError" style="color:#b91c1c;margin-top:.6rem;font-size:.85rem;"></div>
    </form>
  </section>

  
  <section class="card" id="filterCard">
    <div class="card-title" style="margin-bottom:0.9rem;">Search &amp; Filters</div>
    <div class="form-grid">
      <div>
        <label for="filterBill">Bill Number</label>
        <input id="filterBill" type="text" placeholder="e.g. Demo6" />
      </div>
      <div>
        <label for="filterTailor">Tailor Name</label>
        <input id="filterTailor" type="text" placeholder="e.g. Faisal" />
      </div>
      <div>
        <label for="filterStatus">Status</label>
        <select id="filterStatus" class="status-select">
          <option value="ALL">All</option>
          <option value="PENDING">Pending</option>
          <option value="IN_PROGRESS">In Progress</option>
          <option value="DONE">Done</option>
        </select>
      </div>
      <div>
        <label for="filterDateAssigned">Date Assigned</label>
        <input id="filterDateAssigned" type="date" />
      </div>
      <div>
        <label for="filterDateDelivery">Date of Delivery</label>
        <input id="filterDateDelivery" type="date" />
      </div>
      <div style="display:flex;align-items:flex-end;gap:.6rem;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" type="button" id="filterApplyBtn">Search</button>
        <button class="btn btn-secondary btn-sm" type="button" id="filterClearBtn">Clear</button>
      </div>
    </div>
  </section>


<section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem;flex-wrap:wrap;">
      <div class="card-title" style="margin-bottom:0;">All Alteration Work</div>
      <small id="summaryText" style="color:#6b7280;"></small>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Image</th><th>Bill Number</th><th>Tailor Name</th><th>Item Name</th>
            <th>Date Assigned</th><th>Date Delivery</th><th>Time Delivery</th>
            <th>Status</th><th>Packed</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="workTableBody"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="imageModal" class="image-modal">
  <div class="image-modal-backdrop"></div>
  <div class="image-modal-inner">
    <span class="image-modal-close" id="imageModalClose">&times;</span>
    <img id="imageModalImg" src="" alt="Item image" />
  </div>
</div>

<script>
  const API_BASE = "https://chitrali-alteration-api.onrender.com";

  const MAX_FILE_MB = 12;
  const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

  let workItems = [];
  let editingId = null;

  // ✅ ONLY https Cloudinary URL gets saved/sent.
  let uploadedImageUrl = null;

  // ✅ ONLY for preview; never sent/saved.
  let previewObjectUrl = null;

  const addNewWorkBtn = document.getElementById("addNewWorkBtn");
  const formCard = document.getElementById("formCard");
  const formTitle = document.getElementById("formTitle");

  const workForm = document.getElementById("workForm");
  const workIdInput = document.getElementById("workId");
  const billNumberInput = document.getElementById("billNumber");
  const tailorSelect = document.getElementById("tailorSelect");
  const dateAssignedInput = document.getElementById("dateAssigned");
  const dateDeliveryInput = document.getElementById("dateDelivery");
  const timeDeliveryInput = document.getElementById("timeDelivery");
  const itemNameInput = document.getElementById("itemName");
  const statusInput = document.getElementById("status");
  const packedFlagInput = document.getElementById("packedFlag");
  const imageInput = document.getElementById("imageInput");
  const imagePreview = document.getElementById("imagePreview");
  const fileInfo = document.getElementById("fileInfo");
  const notesInput = document.getElementById("notes");
  const saveBtn = document.getElementById("saveBtn");
  const formCancelBtn = document.getElementById("formCancelBtn");
  const saveError = document.getElementById("saveError");

  const summaryText = document.getElementById("summaryText");
  const workTableBody = document.getElementById("workTableBody");

  // --- Search & Filters ---
  const filterBill = document.getElementById("filterBill");
  const filterTailor = document.getElementById("filterTailor");
  const filterStatus = document.getElementById("filterStatus");
  const filterDateAssigned = document.getElementById("filterDateAssigned");
  const filterDateDelivery = document.getElementById("filterDateDelivery");
  const filterApplyBtn = document.getElementById("filterApplyBtn");
  const filterClearBtn = document.getElementById("filterClearBtn");

  // null = no active filters
  let filteredItems = null;


  const imageModal = document.getElementById("imageModal");
  const imageModalImg = document.getElementById("imageModalImg");
  const imageModalClose = document.getElementById("imageModalClose");
  const imageModalBackdrop = imageModal.querySelector(".image-modal-backdrop");

  function openImageModal(src) {
    if (!src) return;
    imageModalImg.src = src;
    imageModal.classList.add("visible");
  }
  function closeImageModal() {
    imageModal.classList.remove("visible");
    imageModalImg.src = "";
  }
  imageModalBackdrop.addEventListener("click", closeImageModal);
  imageModalClose.addEventListener("click", closeImageModal);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeImageModal(); });

  function statusLabel(s){ return s==="IN_PROGRESS"?"In Progress":s==="DONE"?"Done":"Pending"; }
  function statusTint(s){
    if(s==="DONE") return "rgba(34, 197, 94, 0.18)";
    if(s==="IN_PROGRESS") return "rgba(234, 179, 8, 0.18)";
    return "rgba(148, 163, 184, 0.15)";
  }
  function formatDate(d){
    if(!d) return "-";
    const dt = new Date(d);
    return isNaN(dt) ? d : dt.toLocaleDateString("en-IN");
  }
  function formatTime(t){ return t || "-"; }
  function fmtBytes(n){
    if (!Number.isFinite(n)) return "";
    const kb = n/1024;
    if (kb < 1024) return `${Math.round(kb)} KB`;
    return `${(kb/1024).toFixed(2)} MB`;
  }

  function assertNoInlineImage(url) {
    if (!url) return;
    const s = String(url);
    if (s.startsWith("data:image/")) {
      throw new Error("BUG: base64 image detected. Upload must go through /upload, and only https URL can be sent to /alterations.");
    }
    if (s.startsWith("blob:")) {
      throw new Error("BUG: blob preview URL detected. Only https URL can be sent to /alterations.");
    }
  }

  async function apiJson(path, opts = {}) {
    const headers = Object.assign({ "Accept": "application/json" }, opts.headers || {});
    if (opts.body && !(opts.body instanceof FormData)) headers["Content-Type"] = "application/json";
    const res = await fetch(API_BASE + path, { ...opts, headers });
    const text = await res.text();
    const data = text ? (() => { try { return JSON.parse(text); } catch { return text; } })() : null;
    if (!res.ok) {
      const msg = (data && data.error) ? data.error : "Request failed";
      throw new Error(msg);
    }
    return data;
  }

  async function loadWorkAll() {
    workItems = await apiJson("/alterations");
    // keep current filters (if any) after refresh
    if (filteredItems !== null) applyFilters();
    else renderTable();
  }

  function renderSummary(){
    const total = workItems.length;
    const list = filteredItems ?? workItems;
    const showing = list.length;
    const open = list.filter(w => w.status !== "DONE").length;
    summaryText.textContent = `Total: ${total} | Showing: ${showing} | Open: ${open}`;
  }

  function renderTable(){
    const list = filteredItems ?? workItems;
    workTableBody.innerHTML = "";
    if (!list.length) {
      const tr = document.createElement("tr");
      tr.className = "empty-row";
      const td = document.createElement("td");
      td.colSpan = 10;
      td.textContent = "No alteration work found.";
      tr.appendChild(td);
      workTableBody.appendChild(tr);
      renderSummary();
      return;
    }

    list.forEach(w => {
      const tr = document.createElement("tr");

      const tdImg = document.createElement("td");
      const wrap = document.createElement("div");
      wrap.className = "thumb-wrapper";
      if (w.image_url && String(w.image_url).startsWith("http")) {
        const img = document.createElement("img");
        img.src = w.image_url;
        img.style.cursor = "pointer";
        img.addEventListener("click", () => openImageModal(w.image_url));
        wrap.appendChild(img);
      } else {
        wrap.innerHTML = "No<br/>Image";
      }
      tdImg.appendChild(wrap);
      tr.appendChild(tdImg);

      const tdBill = document.createElement("td"); tdBill.textContent = w.bill_number; tr.appendChild(tdBill);
      const tdTailor = document.createElement("td"); tdTailor.textContent = w.tailor_name; tr.appendChild(tdTailor);
      const tdItem = document.createElement("td"); tdItem.textContent = w.item_name; tr.appendChild(tdItem);
      const tdAssigned = document.createElement("td"); tdAssigned.textContent = formatDate(w.date_assigned); tr.appendChild(tdAssigned);
      const tdDelivery = document.createElement("td"); tdDelivery.textContent = formatDate(w.date_delivery); tr.appendChild(tdDelivery);
      const tdTime = document.createElement("td"); tdTime.textContent = formatTime(w.time_delivery); tr.appendChild(tdTime);

      const tdStatus = document.createElement("td");
      const sel = document.createElement("select");
      sel.className = "status-select";
      ["PENDING","IN_PROGRESS","DONE"].forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = statusLabel(val);
        sel.appendChild(opt);
      });
      sel.value = w.status || "PENDING";
      sel.style.background = statusTint(sel.value);
      sel.onchange = async () => {
        try {
          const updated = await updateAlteration(w.id, { status: sel.value });
          sel.style.background = statusTint(updated.status);
        } catch (e) {
          alert("Error updating status: " + e.message);
          sel.value = w.status || "PENDING";
          sel.style.background = statusTint(sel.value);
        }
      };
      tdStatus.appendChild(sel);
      tr.appendChild(tdStatus);

      const tdPacked = document.createElement("td");
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = !!w.packed;
      chk.onchange = async () => {
        try {
          const patch = { packed: chk.checked };
          if (chk.checked) patch.status = "DONE";
          const updated = await updateAlteration(w.id, patch);
          w.status = updated.status;
          w.packed = updated.packed;
          renderTable();
        } catch (e) {
          alert("Error updating packed: " + e.message);
          chk.checked = !!w.packed;
        }
      };
      tdPacked.appendChild(chk);
      tr.appendChild(tdPacked);

      const tdActions = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-link btn-sm";
      editBtn.textContent = "Edit";
      editBtn.onclick = () => loadForEdit(w);
      tdActions.appendChild(editBtn);
      tr.appendChild(tdActions);

      workTableBody.appendChild(tr);
    });

    renderSummary();
  }

  
  function normalizeStr(s){ return (s ?? "").toString().trim().toLowerCase(); }

  function applyFilters(){
    const billQ = normalizeStr(filterBill?.value);
    const tailorQ = normalizeStr(filterTailor?.value);
    const statusQ = (filterStatus?.value || "ALL");
    const assignedQ = filterDateAssigned?.value || "";
    const deliveryQ = filterDateDelivery?.value || "";

    const hasAny =
      billQ || tailorQ || (statusQ && statusQ !== "ALL") || assignedQ || deliveryQ;

    if (!hasAny) {
      filteredItems = null;
      renderTable();
      return;
    }

    filteredItems = workItems.filter(w => {
      if (billQ && !normalizeStr(w.bill_number).includes(billQ)) return false;
      if (tailorQ && !normalizeStr(w.tailor_name).includes(tailorQ)) return false;
      if (statusQ !== "ALL" && (w.status || "PENDING") !== statusQ) return false;

      // dates are stored as YYYY-MM-DD; match exact day when filter provided
      if (assignedQ) {
        const wa = w.date_assigned ? String(w.date_assigned).slice(0,10) : "";
        if (wa !== assignedQ) return false;
      }
      if (deliveryQ) {
        const wd = w.date_delivery ? String(w.date_delivery).slice(0,10) : "";
        if (wd !== deliveryQ) return false;
      }
      return true;
    });

    renderTable();
  }

  function clearFilters(){
    if (filterBill) filterBill.value = "";
    if (filterTailor) filterTailor.value = "";
    if (filterStatus) filterStatus.value = "ALL";
    if (filterDateAssigned) filterDateAssigned.value = "";
    if (filterDateDelivery) filterDateDelivery.value = "";
    filteredItems = null;
    renderTable();
  }

async function updateAlteration(id, patch) {
    const existing = workItems.find(x => x.id === id);
    if (!existing) throw new Error("Record not found");

    const payload = {
      billNumber: existing.bill_number,
      tailorName: existing.tailor_name,
      itemName: existing.item_name,
      dateAssigned: existing.date_assigned,
      dateDelivery: existing.date_delivery,
      timeDelivery: existing.time_delivery,
      status: existing.status || "PENDING",
      packed: !!existing.packed,
      imageUrl: (existing.image_url && String(existing.image_url).startsWith("http")) ? existing.image_url : null
    };

    if (patch.status !== undefined) payload.status = patch.status;
    if (patch.packed !== undefined) payload.packed = patch.packed;

    assertNoInlineImage(payload.imageUrl);

    const updated = await apiJson(`/alterations/${id}`, { method: "PUT", body: JSON.stringify(payload) });
    const idx = workItems.findIndex(x => x.id === id);
    if (idx !== -1) workItems[idx] = updated;
    return updated;
  }

  function cleanupPreviewUrl(){
    if (previewObjectUrl) {
      URL.revokeObjectURL(previewObjectUrl);
      previewObjectUrl = null;
    }
  }

  function resetForm(){
    workForm.reset();
    workIdInput.value = "";
    editingId = null;
    uploadedImageUrl = null;

    cleanupPreviewUrl();

    formTitle.textContent = "Add New Alteration Work";
    saveBtn.textContent = "Add Work";
    saveBtn.disabled = false;

    imagePreview.innerHTML = "<span>Preview</span>";
    imageInput.value = "";
    fileInfo.textContent = "";
    saveError.textContent = "";

    applyStatusTint(statusInput);
  }

  function loadForEdit(w){
    editingId = w.id;
    workIdInput.value = w.id;
    billNumberInput.value = w.bill_number || "";
    tailorSelect.value = w.tailor_name || "";
    itemNameInput.value = w.item_name || "";
    dateAssignedInput.value = w.date_assigned ? String(w.date_assigned).slice(0,10) : "";
    dateDeliveryInput.value = w.date_delivery ? String(w.date_delivery).slice(0,10) : "";
    timeDeliveryInput.value = w.time_delivery || "";
    statusInput.value = w.status || "PENDING";
    packedFlagInput.checked = !!w.packed;
    notesInput.value = w.notes || "";

    uploadedImageUrl = (w.image_url && String(w.image_url).startsWith("http")) ? w.image_url : null;

    cleanupPreviewUrl();
    if (uploadedImageUrl) {
      imagePreview.innerHTML = "";
      const img = document.createElement("img");
      img.src = uploadedImageUrl;
      imagePreview.appendChild(img);
    } else {
      imagePreview.innerHTML = "<span>Preview</span>";
    }

    formTitle.textContent = "Edit Alteration Work";
    saveBtn.textContent = "Update Work";
    applyStatusTint(statusInput);
    fileInfo.textContent = "";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  async function uploadImageIfAny() {
    if (imageInput.files.length === 0) return uploadedImageUrl;

    const file = imageInput.files[0];
    if (file.size > MAX_FILE_BYTES) {
      throw new Error(`Image too large: ${fmtBytes(file.size)}. Please choose a file under ${MAX_FILE_MB} MB.`);
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "Uploading…";

    try {
      const fd = new FormData();
      fd.append("image", file);

      const res = await fetch(API_BASE + "/upload", { method: "POST", body: fd });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = null; }

      if (!res.ok) throw new Error((data && data.error) ? data.error : "Image upload failed");
      if (!data || !data.imageUrl || !String(data.imageUrl).startsWith("http")) throw new Error("Upload did not return https imageUrl");

      uploadedImageUrl = data.imageUrl;
      return uploadedImageUrl;
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = editingId ? "Update Work" : "Add Work";
    }
  }

  async function saveWork(e){
    e.preventDefault();
    saveError.textContent = "";

    const bill = billNumberInput.value.trim();
    const tailor = tailorSelect.value;
    const item = itemNameInput.value.trim();

    if (!bill || !tailor || !item) {
      saveError.textContent = "Bill number, tailor name and item name are required.";
      return;
    }

    if (packedFlagInput.checked) statusInput.value = "DONE";
    applyStatusTint(statusInput);

    try {
      const imageUrl = await uploadImageIfAny();
      assertNoInlineImage(imageUrl);

      const payload = {
        billNumber: bill,
        tailorName: tailor,
        itemName: item,
        dateAssigned: dateAssignedInput.value || null,
        dateDelivery: dateDeliveryInput.value || null,
        timeDelivery: timeDeliveryInput.value || null,
        status: statusInput.value || "PENDING",
        packed: packedFlagInput.checked,
        imageUrl: imageUrl || null
      };

      assertNoInlineImage(payload.imageUrl);

      const path = editingId ? `/alterations/${editingId}` : "/alterations";
      const method = editingId ? "PUT" : "POST";
      await apiJson(path, { method, body: JSON.stringify(payload) });

      await loadWorkAll();
      resetForm();
    } catch (err) {
      saveError.textContent = err.message || "Request failed";
    }
  }

  function applyStatusTint(selectEl){ selectEl.style.background = statusTint(selectEl.value); }


  // Filter listeners
  if (filterApplyBtn) filterApplyBtn.addEventListener("click", applyFilters);
  if (filterClearBtn) filterClearBtn.addEventListener("click", clearFilters);

  // Apply filters on Enter in bill/tailor inputs for quick UX
  [filterBill, filterTailor].forEach(el => {
    if (!el) return;
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); applyFilters(); }
    });
  });

  addNewWorkBtn.addEventListener("click", () => {
    window.scrollTo({ top: formCard.offsetTop - 20, behavior: "smooth" });
  });

  statusInput.addEventListener("change", () => applyStatusTint(statusInput));

  packedFlagInput.addEventListener("change", () => {
    if (packedFlagInput.checked) statusInput.value = "DONE";
    applyStatusTint(statusInput);
  });

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    fileInfo.textContent = "";

    // Selecting a new file means we MUST re-upload to get a new https URL
    uploadedImageUrl = null;

    cleanupPreviewUrl();

    if (!file) {
      imagePreview.innerHTML = "<span>Preview</span>";
      return;
    }

    previewObjectUrl = URL.createObjectURL(file);

    imagePreview.innerHTML = "";
    const img = document.createElement("img");
    img.src = previewObjectUrl;
    imagePreview.appendChild(img);

    if (file.size > MAX_FILE_BYTES) {
      fileInfo.textContent = `Selected: ${fmtBytes(file.size)} (Too large). Please choose < ${MAX_FILE_MB} MB.`;
    } else {
      fileInfo.textContent = `Selected: ${fmtBytes(file.size)} (will upload via /upload)`;
    }
  });

  imagePreview.addEventListener("click", () => {
    const img = imagePreview.querySelector("img");
    if (img && img.src) openImageModal(img.src);
    else if (uploadedImageUrl) openImageModal(uploadedImageUrl);
  });

  workForm.addEventListener("submit", saveWork);
  formCancelBtn.addEventListener("click", resetForm);

  (async function init(){
    resetForm();
    try {
      await apiJson("/health");
      await loadWorkAll();
    } catch (e) {
      summaryText.textContent = "Backend not reachable. Check API_BASE / Render status.";
      console.error(e);
    }
  })();
</script>
</body>
</html>
